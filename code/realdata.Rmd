---
title: "realdata"
author: "mira"
date: "25/07/2022"
output: html_document
---

```{r}
library(dplyr)
library(corrplot)
library(corrgram)
library(readxl)
library(readr)
library(tidyverse)
library(viridis)
library(RColorBrewer)
library(data.table)
library(ggplot2)
library(cdlTools)
library(stargazer)
library(sf)
library(spdep)
library(tmap)
library(lmtest)
library(igraph)
library(grf)
library(gbm)
library(randomForest)

#library(bartMachine)
#library(xgboost)
#library(nnet)
#library(blockCV)
#library(RTransferEntropy)
#library(Rlibeemd)
```

```{r}
source("gps_weightedconformal.R")
```

## define treatment and effect
1. Treatment can be defined as a sharp turning point in oil price. 
This can be clearly pinpointed in time. the change in average HPI growth rates soon before and after the turning point can be compared. GRD/DID can also potentially be applied, neither of which are designed to handle spillovers. 

A few turning points: 
2008 07 high point, boom to bust. financial crisis. For this point, HPI bust leads oil price bust. Hard to interpret without historical context.
2008 12 low point, bust to boom. Seems to parallel small HPI recovery ?
2014 06 high point, stall to crash. Seems to correspond to HPI stall. -----
2020 04 low point, crash to boom. first wave of pandemic.Corresponds to HPI up trend. What's the role of pandemic here? -----

2. Treatment can be defined as a stable period of oil price appreciation/ deflation.
Average HPI growth rates during the period can be compared across locations. The price appreciation expectation formed during the boom would be the driver of HPI growth.
A few periods of stable oil price trends:
2004-2008/07 before financial crisis. ? regression result was OK from stats essay.
2008/12 - 2011/04
2020/04-2021/12 ? regression result opposite to expectation.
2014/06-2016/01 crash

## extra data from ONS
electricity consumption 2005-2020
https://www.gov.uk/government/statistical-data-sets/regional-and-local-authority-electricity-consumption-statistics

employment by occ LA 2021
https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/adhocs/14855employmentbyoccupationandlocalauthoritylocalenterprisepartnership2021

annual rates of migration for local areas 2012-2016
https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/migrationwithintheuk/datasets/annualratesforlocalareamigrationindicators

LQ NUTS 1&2 LA 2015 (SIC3)
https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/datasets/locationquotientdataandgeographicconcentrationfornuts1nuts2andlocalauthorities

Ratio of house price to workplace-based earnings 2021 (not LA level)
https://www.ons.gov.uk/peoplepopulationandcommunity/housing/datasets/ratioofhousepricetoworkplacebasedearningsforformerlocalauthorities

gross disposable household income LA 1997-2016
https://www.ons.gov.uk/economy/regionalaccounts/grossdisposablehouseholdincome/datasets/regionalgrossdisposablehouseholdincomegdhibylocalauthorityintheuk

LA labour demand (job adverts) 2017-2022
https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/articles/labourdemandindicatorsbylocalauthority/january2022

LA GDP 1998-2020
https://www.ons.gov.uk/economy/grossdomesticproductgdp/datasets/regionalgrossdomesticproductlocalauthorities

LA GVA 1997-2015
https://www.ons.gov.uk/economy/grossvalueaddedgva/datasets/regionalgvaibylocalauthorityintheuk

population projection LA 2012-2020
https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationprojections/datasets/localauthoritiesinenglandtable2

employment size LA 2010-2019 (no area code)
https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/datasets/localauthoritycountybusinessregisterandemploymentsurveybrestable5

employment rate from NOMIS
https://www.nomisweb.co.uk/

LA crime counts historical
https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/recordedcrimedataatcommunitysafetypartnershiplocalauthoritylevel/current

employment characteristics
employment in growing decling nd as a share of total employment, business turnover etc.
https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/adhocs/007606employmentcharacteristicsoflocalauthoritiesgreatbritain2015

business register and employment survey?
https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/datasets/localauthoritycountybusinessregisterandemploymentsurveybrestable5


## import data

```{r import_data, eval=FALSE}
# local authorities HPI 01/2004-01/2022 (on average and by house type)
HPI_series <- read_csv("HPI_series.csv")
areas <- unique(HPI_series$AreaCode) # 421 local authorities
# Brent historical spot oil price (dollar per barrel) 2004-2022
brent_series <- read_excel("brent_series.xlsx") # 217 obs
# SP 500 historical price 2004-2019
#SP<-read_csv("SP500.csv")
# UKFTSE100 historical price 2004-2019
#UKFT<-read_csv("UKFTSE100.csv")
```

```{r import_covars, eval=FALSE}
# crime
rec_crimeLA <- read_csv("data1/rec_crimeLA.csv")
rec_crimeLA <-rec_crimeLA[-c(1:179856,22951:57186),c(3,6,7)] # yr 2013
crime <- rec_crimeLA[which(rec_crimeLA$Offence=="Criminal damage and arson"),]
# length(unique(crime$`ONS Code`)) # only 311 and lots of 'placeholder' ???
crime <-crime[,-2]
colnames(crime)<-c("AreaCode","offences")

# population and household income
population <- read_excel("data1/grosshouseholdincomeLA19972015.xlsx", sheet = "Population")
pop13<-population[,c(2,20)]
colnames(pop13)<-c("AreaCode","pop2013")
pop13<-left_join(pop13,map[,c(2,9)],by=c("AreaCode"="lad19cd"))
pop13$popden<-pop13$pop2013/(pop13$st_areasha*0.0001)
pop13<-pop13[,c(1,5)]

income <- read_excel("data1/grosshouseholdincomeLA19972015.xlsx", sheet = "Gross disposable income")
income13<-income[,c(2,20)]
colnames(income13)<-c("AreaCode","income2013")
length(pop13$AreaCode) # 391

# GDP, GDPPC, GVA, another population count
GVA <- read_excel("data1/GDP_LA1998-2020.xlsx", sheet = "GVA_cur_price")
GDP <- read_excel("data1/GDP_LA1998-2020.xlsx", sheet = "GDP_cur_price")
GDPPC <- read_excel("data1/GDP_LA1998-2020.xlsx", sheet = "GDPPC_cur_price")
resident <- read_excel("data1/GDP_LA1998-2020.xlsx", sheet = "resident_pop")
GVA13 <- GVA[,c(2,19)]
colnames(GVA13)<-c("AreaCode","GVA13")
GDP13 <- GDP[,c(2,19)]
colnames(GDP13)<-c("AreaCode","GDP13")
GDPPC13 <- GDPPC[,c(2,19)]
colnames(GDPPC13)<-c("AreaCode","GDPPC13")
resident13 <- resident[,c(2,19)]
colnames(resident13)<-c("AreaCode","resident13")
length(GDPPC13$AreaCode) # 374

# employment
employ2015 <- read_excel("data1/employcharacteristicsLA2015.xls", sheet = "Table 1")
employ <-employ2015[,c(1,5,8,10,11,15,25,28,30,31,33,34)]
employ[293,9]<-"20"
employ$demale_lfexp<-as.numeric(employ$demale_lfexp)
length(employ$AreaCode) # 379

# energy consumption (and domestic units supply ?)
# the number of new meters across years can sub for supply. Table 122 is England only.
electricity13 <- read_excel("data1/electricityLA2005-2020.xlsx", sheet = "2013")
electricity13 <-electricity13[,c(1,6,7,11,12,16,17)]
colnames(electricity13)<-c("AreaCode","dom_count13","n_dom_count13","dom_consum13","n_dom_consum13","mean_dom13","mean_n_dom13")
electricity14 <- read_excel("data1/electricityLA2005-2020.xlsx", sheet = "2014")
electricity14 <-electricity14[,c(1,6)]
colnames(electricity14)<-c("AreaCode","dom_count14")
electricity<-left_join(electricity13,electricity14,by="AreaCode")
electricity$supply<-electricity$dom_count14-electricity$dom_count13
electricity<-electricity[,-8]
length(electricity$AreaCode) # 380

# migration rate
migrationLA20122016 <- read_excel("data1/migrationLA20122016.xls", sheet = "2013")
migration <- migrationLA20122016[-c(1:18),c(4,8:11)]
colnames(migration)<-c("AreaCode","turn_int","inflow_int","outflow_int","turn_dom")
migration$turn_int<-as.numeric(migration$turn_int)
migration$inflow_int<-as.numeric(migration$inflow_int)
migration$outflow_int<-as.numeric(migration$outflow_int)
migration$turn_dom<-as.numeric(migration$turn_dom)
length(migration$AreaCode)# 425

# industry LQ
LQ2015 <- read_excel("data1/LQLA2015.xls", sheet = "LALQ")
LQ2015 <- LQ2015[,c(2,8,9,10,14,15,18,19,20)]
LQ2015[349,6]<-LQ2015[369,6]<-LQ2015[379,6]<-"0.05"
LQ2015$Professional<-as.numeric(LQ2015$Professional)
LAs<-GVA[,c(2,3)]
colnames(LAs)<-c("AreaCode","Area")
LQ2015<-left_join(LQ2015,LAs)
# LAlist<-map$lad19cd
# LQ2015<-left_join(LQ2015,LAlist)
LQ2015[c(99:105,179,184,187:189,235:238,262,291,297,310:315,325:327,340,342,360,361),10]<-c("E07000150","E07000151","E07000152","E07000153","E07000154","E07000155","E07000156","E07000146","E07000201","E07000204","E07000205","E07000206","E07000004","E07000005","E07000006","E07000007","E07000112","E06000028","E06000029","E07000048","E07000049","E07000050","E07000051","E07000052","E07000053","E07000190","E07000191","W06000001","W06000014","W06000016","S12000036","S12000013") # fixing some AreaCode
LQ2015<-LQ2015[,-1] # lose the Area name
length(LQ2015$AreaCode) # 380

# covars 
LAlist<-data.frame(AreaCode=map$lad19cd,Area=map$lad19nm)

covars<-list(LAlist,pop13,income13,GVA13,GDP13,GDPPC13,employ,electricity,LQ2015)%>%reduce(left_join,by="AreaCode") 
# Northern Ireland mostly missing except for GDP related.
nacount<-c()
for (i in 1:31){
  nacount[i]=length(which(is.na(covars[,i+2])))
}
nacount
# migration too many missing, use employ/migration instead
# GDP LAs are diff from others'

covars0<-drop_na(covars)
# obs 350 out of 382 LAs
# some LA codes are not matching

corr<-cor(covars0[,-c(1,2)])
corrplot(corr,tl.col="black",tl.cex=0.6)
# check colinearity and corr with cut2, drop some vars
covars0<-covars0[,-c(6,7,8,13,17,19,20,21,22,27,28,33)] # 19 vars left

#covars0<-left_join(covars0,HPI_series2.w[,c(1,15)])
#corr<-cor(covars0[,-c(1,2)])
```


```{r format_HPI, eval=FALSE}
HPI_series<-HPI_series[,c(1,4,5,7,8,9)] # date, area, areacode, index, 1m%, 12m%
HPI_series2<-HPI_series[,c(1,3,5)] # date, areacode, 1m%,
HPI_series2.w <- HPI_series2 %>% pivot_wider(names_from=Date,values_from = `1m%Change`)
HPI_series2.w <-HPI_series2.w [,1:218]

# monthly growth rates averaged. affected by different smoothness of the trends
# average monthly growth during 2004-2008/07
HPI_series2.w$grow1 <- rowMeans(HPI_series2.w[,17:56])
# average monthly growth during 2008/12 - 2011/04
HPI_series2.w$grow2 <- rowMeans(HPI_series2.w[,61:89])
# average monthly growth during 2014/06-2016/01
HPI_series2.w$grow3 <- rowMeans(HPI_series2.w[,127:146])
# average monthly growth during 2020/04-2021/12
HPI_series2.w$grow4 <- rowMeans(HPI_series2.w[,197:217])

# average monthly growth prior 2008 07
HPI_series2.w$prior1 <- rowMeans(HPI_series2.w[,45:56])
# average monthly growth post 2008 07
HPI_series2.w$post1 <- rowMeans(HPI_series2.w[,56:61])
# average monthly growth prior 2008 12
HPI_series2.w$prior2 <- rowMeans(HPI_series2.w[,56:61])
# average monthly growth post 2008 12
HPI_series2.w$post2 <- rowMeans(HPI_series2.w[,61:72])
# average monthly growth prior 2014 06
HPI_series2.w$prior3 <- rowMeans(HPI_series2.w[,116:127])
# average monthly growth post 2014 06
HPI_series2.w$post3 <- rowMeans(HPI_series2.w[,127:138])
# average monthly growth prior 2020 04
HPI_series2.w$prior4 <- rowMeans(HPI_series2.w[,186:197])
# average monthly growth post 2020 04
HPI_series2.w$post4 <- rowMeans(HPI_series2.w[,197:208])

HPI_series2.w <- HPI_series2.w[,c(1,219:230)]
# maybe calculate average growth rate differently? from start and end HPI

HPI_series2.w$cut1<-HPI_series2.w$post1-HPI_series2.w$prior1
HPI_series2.w$cut2<-HPI_series2.w$post2-HPI_series2.w$prior2
HPI_series2.w$cut3<-HPI_series2.w$post3-HPI_series2.w$prior3
HPI_series2.w$cut4<-HPI_series2.w$post4-HPI_series2.w$prior4

par(mfrow=c(3,3))
hist(HPI_series2.w $grow1) 
hist(HPI_series2.w $grow2) 
hist(HPI_series2.w $grow3)
hist(HPI_series2.w $grow4)
hist(HPI_series2.w $cut1) 
hist(HPI_series2.w $cut2)
hist(HPI_series2.w $cut3)
hist(HPI_series2.w $cut4)
```


```{r HPI_map, eval=FALSE}
# map the house price growth across LAs
map <- st_read('Local_Authority_Districts_(December_2019)_Boundaries_UK_BUC.shp')
#class(map) # sf
#head(map) # LA ID in lad19cd, 382 obs
map <- left_join(map,HPI_series2.w,by=c("lad19cd"="AreaCode"))

plot1<-function(map,c){
  tm_shape(map)+
  tm_fill(col=c(c),palette="-RdBu",style = "quantile", n = 9,midpoint=0)+
  tm_borders(col='black',lwd=0.1)+
  tm_scale_bar()+
  tm_layout(legend.outside = TRUE)
}

plot1(map, c("grow1","grow2"))
plot1(map,c("grow3","grow4"))
plot1(map,c("cut1","cut2"))
plot1(map,c("cut3","cut4"))

```


```{r oil_loc, eval=FALSE}
# add measurements of oil industry concentration, based on ONS labour statistics
oil_prod <- c("E09000001","E09000033","E07000085","E10000030","S12000034","E07000209")
oilgas_prod <- c("E09000001","E09000033","E07000085","E10000030","S12000034","E07000209","E08000022","E07000127","E07000147","E07000146","E06000011","E08000021")

map$oilgas_prod <- ifelse(map$lad19cd%in%oilgas_prod,1,0) 
HPI_series2.w$oilgas_prod<- ifelse(HPI_series2.w$AreaCode%in%oilgas_prod,1,0) 

# check group means
mean(HPI_series2.w$grow1[which(HPI_series2.w$oilgas_prod==1)])
mean(HPI_series2.w$grow1[which(HPI_series2.w$oilgas_prod==0)])

boxplot(HPI_series2.w$grow1[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$grow1[which(HPI_series2.w$oilgas_prod==0)],
        HPI_series2.w$grow2[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$grow2[which(HPI_series2.w$oilgas_prod==0)],
        HPI_series2.w$grow3[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$grow3[which(HPI_series2.w$oilgas_prod==0)],
        HPI_series2.w$grow4[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$grow4[which(HPI_series2.w$oilgas_prod==0)],
        main="Growth across periods")
boxplot(HPI_series2.w$cut1[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$cut1[which(HPI_series2.w$oilgas_prod==0)],
        HPI_series2.w$cut2[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$cut2[which(HPI_series2.w$oilgas_prod==0)],
        HPI_series2.w$cut3[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$cut3[which(HPI_series2.w$oilgas_prod==0)],
        HPI_series2.w$cut4[which(HPI_series2.w$oilgas_prod==1)],
        HPI_series2.w$cut4[which(HPI_series2.w$oilgas_prod==0)],
        main="Growth across turning points")
# the oil price decline during 2014/06-2016/01 and the turning point leading to this period seem to affect oil prod locations more.
# corresponding outcome vars: grow3 cut3

# does it look different with outliers removed?
```




```{r dist2nearest_hub, eval=FALSE}
# calculate each LA's distance to nearest oil_gas production hubs
# get ID of oil_gas hubs and select columns in distance matrix with such ID
ID <- which(centroids$lad19cd%in%oilgas_prod)
dist <- as.data.frame(distance_matrix[,ID]) #382*10
# get every LA's distance to the nearest hub
min_dist<- NULL
for (i in 1:382) {
  min_dist[i] <- min(dist[i,])
}
min_dist<- as.data.frame(min_dist)
min_dist$AreaCode<-centroids$lad19cd
HPI_series2.w <- left_join(HPI_series2.w,min_dist)
hist(log(HPI_series2.w$min_dist)) # looks fine
```


```{r merge_data2, eval=FALSE}
# add more covariates
HPI_series2.w <- left_join(HPI_series2.w,covars0,by="AreaCode")
map <- left_join(map,covars0,by=c("lad19cd"="AreaCode"))
```


```{r A_matrix, eval=FALSE}
# generate matrix after all covars are added to map and all NA rows are dropped.
map2<-map[,-4]
map2<-drop_na(map2) # 350 obs

# create distance/adj matrix 
centroids <- st_point_on_surface(x=map2)
distance_matrix <- st_distance(centroids,centroids) # 382 * 382 with m as unit
dist<-list()
for (i in 1:350){dist[[i]]<-as.numeric(distance_matrix[,i])}
dist<- do.call(cbind.data.frame,dist)
colnames(dist)<-map2$lad19cd

# set a distance threshold and create adj matrix
A_adj<-list()
for (i in 1:350){A_adj[[i]]<-ifelse(dist[,i]<50000,1,0)}
A_adj<- do.call(cbind.data.frame,A_adj)
colnames(A_adj)<-map2$lad19cd # A-adj is symmetric
# A_adj<-t(A_adj)
# hist(rowSums(A_adj))
# quantile(rowSums(A_adj),0.8) # 0.05-3  0.8-36  

# cap A_adj connections at 20 neighbors
n20<-list()
for (i in 1:350){
  t<-as.numeric(dist[i,])
  ord<- order(t)
  thresh<-t[ord[21]]
  n20[[i]]<-ifelse(t<thresh,1,0)
}
n20<- do.call(cbind.data.frame,n20)
colnames(n20)<-map2$lad19cd
n20<-t(n20)
# rowSums(n25) # ==25  colSums != 25, near neigh matrix not symmetric
A_adj2<-A_adj*n20

# handle island LAs
isl<-list()
island<-which(rowSums(A_adj2)<4) 
for (i in 1:length(island)){
  idx<-island[i]
  t<-as.numeric(dist[idx,])
  ord<- order(t)
  thresh<-t[ord[4]]
  isl<-ifelse(t<thresh,1,0)
  A_adj2[idx,]<-t(isl)
}
diag(A_adj2)<-0
# hist(rowSums(A_adj2))


# KNN8 matrix
n8<-matrix(nrow=350,ncol=350)
for (i in 1:350){
  t<-as.numeric(dist[i,])
  ord<- order(t)
  thresh<-t[ord[10]]
  n8[i,]<-ifelse(t<thresh,1,0)
}
diag(n8)<-0
#rowSums(n8)

# map the connections
net<-graph_from_adjacency_matrix(as.matrix(n8),mode="undirected")
vertex_attr(net,"x")<-map2$long
vertex_attr(net,"y")<-map2$lat
plot(net,vertex.size = 2,vertex.label = NA,
     axes=TRUE,margin=c(0,0,0,0),main="LA neighbour structure",xlim=c(-1,1))

```

```{r}
save(A_adj,A_adj2,map2,HPI_series2.w,file="HPI_data.Rdata")
```


```{r regression, eval=FALSE}
# cross-sectional regression for sanity checks
# modeling liquidity shock by international oil price movement
# HPI growth explained by oil_gas hubs, distance to oil_gas hubs, supply, demand

m1 <- glm(log(grow1+1)~as.factor(oilgas_prod)+log(`2013.x`+10)+log(supply1+1),data=HPI_series2.w)
m2 <- glm(grow2~as.factor(oilgas_prod)+log(`2013.x`+10)+log(supply2+1),data=HPI_series2.w)
m3 <- glm(grow3~as.factor(oilgas_prod)+log(`2013.x`+10)+log(supply3+1),data=HPI_series2.w)

m11 <- glm(log(grow1+1)~as.factor(oil_prod)+log(`2013.x`+10)+log(supply1+1),data=HPI_series2.w)
m22 <- glm(grow22~as.factor(oil_prod)+log(`2013.x`+10)+log(supply2+1),data=HPI_series2.w)
m33 <- glm(grow3~as.factor(oil_prod)+log(`2013.x`+10)+log(supply3+1),data=HPI_series2.w)

m11 <- glm(log(grow1+1)~as.factor(oil_prod)+log(min_dist+1)+log(`2013.x`+10)+log(supply1+1),data=HPI_series2.w)
m22 <- glm(grow2~as.factor(oil_prod)+log(min_dist+1)+log(`2013.x`+10)+log(supply2+1),data=HPI_series2.w)
m33 <- glm(grow3~as.factor(oil_prod)+log(min_dist+1)+log(`2013.x`+10)+log(supply3+1),data=HPI_series2.w)

m111 <- glm(log(grow1+1)~log(min_dist+1)+log(`2013.x`+10)+log(supply1+1),data=HPI_series2.w)
m222 <- glm(grow2~log(min_dist+1)+log(`2013.x`+10)+log(supply2+1),data=HPI_series2.w)
m333 <- glm(grow3~log(min_dist+1)+log(`2013.x`+10)+log(supply3+1),data=HPI_series2.w)
#summary(m1)
stargazer(m1,m2,m3,m11,m22,m33,type="text")

```

```{r DID, eval=FALSE}
# standard DID. Y=beat0 + beta1*Treat + beta2*post + beta3*Treat*post + epsilon
# the estimate of ATT is beta3 for the interaction term between the dummy for being treated and the dummy for obs post treatment.
# for the HPI case, oil production cities and others are not balanced in major ways. can try PSM?

# format data to long and define post treatment dummy variable.
HPI_DID<-HPI_series2.w[,c(6,18,19,21)]
HPI_DID$post<-0
colnames(HPI_DID)<-c("HPI_rate","oil","post")
HPI_DID2<-HPI_series2.w[,c(7,18,19,21)]
HPI_DID2$post<-1
colnames(HPI_DID2)<-c("HPI_rate","oil","post")
HPI_DID<-rbind.data.frame(HPI_DID,HPI_DID2)
DID1 <- lm(HPI_rate~ oil + post + oil:post, data=HPI_DID)
summary(DID1)
# cut1  oil:post coeff 0.425 not significant
# cut2  oil:post coeff -0.515 not significant
# cut3  oil:post coeff -0.055 not significant but the right sign
# cut4  oil:post coeff -0.378 significant but the wrong sign
```


```{r conformal, eval=FALSE}
# data: map2  use map data for convenience of weight matrix
# variables: Tr:brent, Y:grow3, cut3.
# test on all cities. 
HPItestid <- sample(350,3) 

HPI_tr <- map2$oilgas_prod # 11
A_adj2<-as.matrix(A_adj2) # 350*350 index by rows

HPI_covar <-st_drop_geometry(map2)
HPI_covar <- HPI_covar[,28:46]

# check observed treatment status of locations
G_est<-get_trnei1(HPI_tr,n8,"adj") # A_adj2 (117) n8(74)
T_est <- data.frame(AreaCode=map2$lad19cd,tr=paste0("t",HPI_tr,G_est))
length(which(T_est$tr=="t01")) 
length(which(T_est$tr=="t00")) 
# since there are only 11 treated units. the sum of t11 and t10 will be 11
# there is not enough data to estimate ps for these treatment levels
# instead, can estimate ps for t01 and t00 to predict spillover effect for control units t01-t00.
# explore t01 t00 counts under diff cutoff setting 
# adj2: 0.05/ 0.01(110,229)
# n8 0.01/ 0.05(68,271)

# with 70% coverage. QRF cannot work with such small sample size. use QBART.
# growth rates in period 3.
HPI_res1 <- conformal_ITE_e(X=HPI_covar,Y=map2$grow3,
                          testid=HPItestid,
                          tr=HPI_tr,
                          A=A_adj2,Atype="adj",
                          ps_pred_model="binomial",
                          ps=NA,G=NA,outfun="QBART",CQR=TRUE,retrainYmodel=TRUE)
# change in growth rates over turning point 3.
HPI_res2 <- conformal_ITE_e(X=HPI_covar,Y=map2$cut3,
                          testid=HPItestid,
                          tr=HPI_tr,
                          A=A_adj2,Atype="adj",
                          ps_pred_model="binomial",
                          ps=NA,G=NA,outfun="QBART",CQR=TRUE,retrainYmodel=TRUE)
HPI_tr[HPItestid]
map2$cut3[HPItestid]
map2$grow3[HPItestid]

range(map2$grow3) # -0.2151719  1.5327499
HPI_res1[[2]] # -0.198286	1.79591	-0.1203036	1.306398

range(map2$cut3) # -1.608384  2.116998
HPI_res2[[2]] # -2.720227	2.116835	-1.026769	0.7937137

# save(HPI_res1,HPI_res2,file="HPI_ITE_results.Rdata")
```

```{r plot}

HPI_res0<-cbind.data.frame(HPI_series2.w$AreaCode,HPI_res1[[1]],HPI_res1[[2]])
colnames(HPI_res0) <- c("AreaCode","PO_lo11","PO_hi11","PO_lo10","PO_hi10","PO_lo01","PO_hi01","PO_lo00","PO_hi00",
                        "spill1_lo","spill1_hi","spill0_lo","spill0_hi","direct1_lo","direct1_hi","direct0_lo","direct0_hi")
map2 <- left_join(map2,HPI_res0,by=c("lad19cd"="AreaCode"))
# plotting the estimated spillover effects
plot1(map2, c("spill0_hi","spill0_lo"))
plot1(map2, c("spill1_hi","spill1_lo"))


```

