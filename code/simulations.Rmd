---
title: "Simulations"
author: "mira"
date: "2022/6/12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Demonstration of spatial conformal with gps on simulated data

```{r , eval=FALSE}

```

The covariates $X_{ij}$ are i.i.d. generated from $\mathrm{Unif}([0, 1])$ 

$Y_{i}(0)\equiv 0$
$\mathbb{E}[Y_{i}(1) \mid X_{i}] = f(X_{i1})f(X_{i2})$ 
where
$$f(x) = \frac{2}{1 + \exp(-12(x - 0.5))}$$
$Y_{i}(1) = \mathbb{E}[Y_{i}(1) \mid X_{i}] + \epsilon_{i}$
where $\epsilon_{i}\stackrel{i.i.d.}{\sim}N(0, 1)$. 

The propensity score $e(x) \triangleq P(T_{i} = 1\mid X_{i} = x)$ is set as follows:
$$e(x) = \frac{1}{4}(1 + \beta_{2, 4}(x),$$
where $\beta_{2, 4}(x)$ is the cdf of the Beta-distribution with parameters $2$ and $4$.

The outcome variable `Y` used by `conformalCf` should be a mixture of observed values and missing values while the covariate matrix `X` should have no missing values. It can handle general missing value problems with ignorable missing mechanisms. The inference of counterfactuals under the potential outcome framework with ignorable treatment assignment is thus a special case. 

```{r do not run, include=FALSE, eval=FALSE}
set.seed(123)
genY <- function(X){
    2 / (1 + exp(-12 * (X[, 1] - 0.5))) * 2 / (1 + exp(-12 * (X[, 2] - 0.5))) + rnorm(n)
}
n <- 1000
d <- 10
X <- matrix(runif(n * d), nrow = n, ncol = d)
Y <- genY(X)
ps <- (1 + pbeta(X[, 1], 2, 4)) / 4
T <- as.numeric(ps < runif(n))
Y[!T] <- NA
summary(Y)
```


```{r demon setup, include=TRUE, eval=FALSE}
# CF for counterfactuals
# Generate data
set.seed(123)
n <- 1000
d <- 5
X <- matrix(rnorm(n * d), nrow = n) # 1000*5
beta <- rep(1, 5)

# Y with missing vals
Y2 <- X %*% beta + rnorm(n) # 1000*1
missing_prob <- pnorm(X[, 1]) 
if_missing <- missing_prob < runif(n) 
Y2[if_missing] <- NA
sum(is.na(Y2)) 

# Y with random treatment
Y1 <- X %*% beta + rnorm(n)
Y0 <- rnorm(n)
ps <- pnorm(X[, 1]) # propensity
T <- as.numeric(ps < runif(n))
Y <- ifelse(T == 1, Y1, Y0)

# Generate testing data
ntest <- 5
Xtest <- matrix(rnorm(ntest * d), nrow = ntest) # 5*5
```


```{r demon 1 Cf,  include=TRUE, eval=FALSE}
# CF for counterfactuals

# Run weighted CQR-CV
conformalCf_CV(X, Y2, psfun="Boosting", outfun = "quantRF",nfolds=4)

```


```{r demon 2 ITE,  include=TRUE, eval=FALSE}
# CF for ITE

# Naive method, CV, 
CI <- conformalIte(X, Y, T,
                   psfun="Boosting", outfun = "quantRF",nfolds=4,Xtest=Xtest)


# Counterfactual method, Y and T needs to be observed


```

